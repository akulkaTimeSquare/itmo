import numpy as np
from scipy.signal import place_poles

print("="*80)
print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –†–ï–®–ï–ù–ò–Ø –ó–ê–î–ê–ß–ò –°–ò–ù–¢–ï–ó–ê –†–ï–ì–£–õ–Ø–¢–û–†–ê")
print("–° –ó–ê–î–ê–ù–ù–û–ô –°–¢–ï–ü–ï–ù–¨–Æ –°–•–û–î–ò–ú–û–°–¢–ò")
print("="*80)

# –ò—Å—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏—Å—Ç–µ–º—ã
n = 11
rng = np.random.default_rng(n)
M = rng.integers(100000, 1000000) / 1000 / np.sqrt(2)
m = rng.integers(1000, 10000) / 1000 * np.sqrt(3)
l = rng.integers(100, 1000) / np.sqrt(5) / 100
g = 9.81

print(f"\nüìã –ü–ê–†–ê–ú–ï–¢–†–´ –°–ò–°–¢–ï–ú–´:")
print(f"   M = {M:.3f} –∫–≥ (–º–∞—Å—Å–∞ —Ç–µ–ª–µ–∂–∫–∏)")
print(f"   m = {m:.3f} –∫–≥ (–º–∞—Å—Å–∞ –º–∞—è—Ç–Ω–∏–∫–∞)")
print(f"   l = {l:.3f} –º (–¥–ª–∏–Ω–∞ –º–∞—è—Ç–Ω–∏–∫–∞)")
print(f"   g = {g} –º/—Å¬≤ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è)")

# –ú–∞—Ç—Ä–∏—Ü—ã —Å–∏—Å—Ç–µ–º—ã
A = np.array([
    [0, 1, 0, 0],
    [0, 0, 3*m*g/(4*M + m), 0],
    [0, 0, 0, 1],
    [0, 0, 6*(M + m)*g/l/(4*M + m), 0]
])

B = np.array([
    [0],
    [4 / (4*M + m)],
    [0],
    [6 / l / (4*M + m)]
])

print(f"\nüîç –ê–ù–ê–õ–ò–ó –°–ò–°–¢–ï–ú–´:")
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç–∏
def controllability_matrix(A, B):
    n = A.shape[0]
    C = B.copy()
    for i in range(1, n):
        C = np.hstack([C, np.linalg.matrix_power(A, i) @ B])
    return C

Wc = controllability_matrix(A, B)
rank_Wc = np.linalg.matrix_rank(Wc)
print(f"   ‚Ä¢ –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã: {A.shape[0]}")
print(f"   ‚Ä¢ –†–∞–Ω–≥ –º–∞—Ç—Ä–∏—Ü—ã —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç–∏: {rank_Wc}")
print(f"   ‚Ä¢ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—è–µ–º–∞: {'‚úì' if rank_Wc == A.shape[0] else '‚ùå'}")

# –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∏—Å–ª–∞ –æ—Ç–∫—Ä—ã—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã
eig_open = np.linalg.eigvals(A)
max_real_open = np.max(np.real(eig_open))
print(f"   ‚Ä¢ –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∏—Å–ª–∞ –æ—Ç–∫—Ä—ã—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã: {eig_open}")
print(f"   ‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å: {max_real_open:.3f}")
print(f"   ‚Ä¢ –û—Ç–∫—Ä—ã—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞: {'—Å—Ç–∞–±–∏–ª—å–Ω–∞' if max_real_open < 0 else '–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞'}")

# –ó–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–µ–ø–µ–Ω–∏ —Å—Ö–æ–¥–∏–º–æ—Å—Ç–∏
a1 = 0.5
a2 = 3.0

print(f"\nüéØ –¢–†–ï–ë–û–í–ê–ù–ò–Ø:")
print(f"   ‚Ä¢ –°—Ç–µ–ø–µ–Ω—å —Å—Ö–æ–¥–∏–º–æ—Å—Ç–∏ Œ±‚ÇÅ = {a1}")
print(f"   ‚Ä¢ –°—Ç–µ–ø–µ–Ω—å —Å—Ö–æ–¥–∏–º–æ—Å—Ç–∏ Œ±‚ÇÇ = {a2}")
print(f"   ‚Ä¢ –í—Å–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∏—Å–ª–∞ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å Re(Œª) < -Œ±")

# –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–æ–ª—é—Å–æ–≤
print(f"\n‚öôÔ∏è –°–ò–ù–¢–ï–ó –†–ï–ì–£–õ–Ø–¢–û–†–ê –ú–ï–¢–û–î–û–ú –†–ê–ó–ú–ï–©–ï–ù–ò–Ø –ü–û–õ–Æ–°–û–í:")

desired_poles_1 = [-a1-0.1, -a1-0.2, -a1-0.3, -a1-0.4]
desired_poles_2 = [-a2-0.1, -a2-0.2, -a2-0.3, -a2-0.4]

print(f"   ‚Ä¢ –ñ–µ–ª–∞–µ–º—ã–µ –ø–æ–ª—é—Å–∞ –¥–ª—è Œ±‚ÇÅ={a1}: {desired_poles_1}")
print(f"   ‚Ä¢ –ñ–µ–ª–∞–µ–º—ã–µ –ø–æ–ª—é—Å–∞ –¥–ª—è Œ±‚ÇÇ={a2}: {desired_poles_2}")

result1 = place_poles(A, B, desired_poles_1)
K1 = result1.gain_matrix
result2 = place_poles(A, B, desired_poles_2)
K2 = result2.gain_matrix

e1 = np.linalg.eigvals(A - B @ K1)
e2 = np.linalg.eigvals(A - B @ K2)

def print_matrix(Min, prec=4):
    for row in Min:
        print("      " + "  ".join(f"{val:.{prec}f}" for val in row))

print(f"\nüìä –†–ï–ó–£–õ–¨–¢–ê–¢–´:")
print(f"   –°–∏—Å—Ç–µ–º–∞ 1 (Œ±‚ÇÅ={a1}):")
print(f"   ‚Ä¢ –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∏—Å–ª–∞: {e1}")
print(f"   ‚Ä¢ –ú–∞–∫—Å. –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å: {np.max(np.real(e1)):.6f}")
print(f"   ‚Ä¢ –£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {'‚úì' if np.max(np.real(e1)) < -a1 else '‚ùå'}")
print(f"   ‚Ä¢ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ K‚ÇÅ:")
print_matrix(K1, 4)

print(f"\n   –°–∏—Å—Ç–µ–º–∞ 2 (Œ±‚ÇÇ={a2}):")
print(f"   ‚Ä¢ –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∏—Å–ª–∞: {e2}")
print(f"   ‚Ä¢ –ú–∞–∫—Å. –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å: {np.max(np.real(e2)):.6f}")
print(f"   ‚Ä¢ –£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {'‚úì' if np.max(np.real(e2)) < -a2 else '‚ùå'}")
print(f"   ‚Ä¢ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ K‚ÇÇ:")
print_matrix(K2, 4)

print(f"\nüèÜ –ò–¢–û–ì–û–í–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:")
success1 = np.max(np.real(e1)) < -a1
success2 = np.max(np.real(e2)) < -a2

if success1 and success2:
    print("   ‚úÖ –ó–ê–î–ê–ß–ê –†–ï–®–ï–ù–ê –£–°–ü–ï–®–ù–û!")
    print("   ‚Ä¢ –û–±–µ —Å–∏—Å—Ç–µ–º—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –∑–∞–¥–∞–Ω–Ω—É—é —Å—Ç–µ–ø–µ–Ω—å —Å—Ö–æ–¥–∏–º–æ—Å—Ç–∏")
    print("   ‚Ä¢ –ú–µ—Ç–æ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–æ–ª—é—Å–æ–≤ –ø–æ–∫–∞–∑–∞–ª –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã")
else:
    print("   ‚ùå –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã")

print(f"\nüìù –í–´–í–û–î–´:")
print("   ‚Ä¢ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—è–µ–º–∞ –∏ –ø–æ–¥–¥–∞–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏")
print("   ‚Ä¢ –ú–µ—Ç–æ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–æ–ª—é—Å–æ–≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è –¥–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏")
print("   ‚Ä¢ SDP –ø–æ–¥—Ö–æ–¥ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π")
print("   ‚Ä¢ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ä–µ–≥—É–ª—è—Ç–æ—Ä—ã –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é")

print("\n" + "="*80)
